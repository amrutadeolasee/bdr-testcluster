# {{ansible_managed}}
#
# Configuration snippet generated by Ansible by the bdr_07x_upgrade role

{% set conns = [] %}
{% for x in groups[bdrgroupname] %}
{%   if x != inventory_hostname %}
{%     set ignored = conns.append(x) %}
{%   endif %}
{% endfor %}

{% for x in groups[newbdrgroupname] %}
{%   set ignored = conns.append(x)%}
{% endfor %}

bdr.connections = '{{ conns | join(',') }}'

{% for nodename in groups[bdrgroupname] %}
{%   if nodename != inventory_hostname %}
bdr.{{nodename}}_dsn = 'port={{hostvars[nodename]['postgres_port']}} user={{hostvars[nodename]['postgres_superuser']}} dbname={{hostvars[nodename]['bdr_node_database']}}'
{%     if inventory_hostname != groups[bdrgroupname][0] and nodename == groups[bdrgroupname][0] %}
# clone this node inventory_hostname from {{groups[bdrgroupname][0]}}, the first node
bdr.{{nodename}}_init_replica = on
bdr.{{nodename}}_replica_local_dsn = 'port={{postgres_port}} dbname={{bdr_node_database}} user={{postgres_superuser}}'

{%     endif %}
{%   endif %}
{% endfor %}

{% for nodename in groups[newbdrgroupname] %}
bdr.{{nodename}}_dsn = 'port={{hostvars[nodename]['postgres_port']}} user={{hostvars[nodename]['postgres_superuser']}} dbname={{hostvars[nodename]['bdr_node_database']}}'
{% endfor %}
